service: nebbulon-news-api

provider:
  name: aws
  runtime: nodejs18.x
  region: ap-south-1
  stage: ${opt:stage, 'dev'}
  memorySize: 512
  timeout: 30
  
  environment:
    DYNAMODB_TABLE_NEWS: ${self:service}-articles-${self:provider.stage}
    DYNAMODB_TABLE_SUBSCRIBERS: ${self:service}-subscribers-${self:provider.stage}
    DYNAMODB_TABLE_COMMENTS: ${self:service}-comments-${self:provider.stage}
    DYNAMODB_TABLE_ANALYTICS: ${self:service}-analytics-${self:provider.stage}
    S3_BUCKET_NAME: ${self:service}-images-${self:provider.stage}
    CLOUDFRONT_DOMAIN: ${cf:${self:service}-${self:provider.stage}.CloudFrontDomain}
    SES_FROM_EMAIL: noreply@nebbulon.com
    WEBSITE_URL: https://nebbulon.com
  
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_NEWS}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_NEWS}/index/*
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_SUBSCRIBERS}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_COMMENTS}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_COMMENTS}/index/*
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_ANALYTICS}
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
            - s3:PutObjectAcl
          Resource:
            - arn:aws:s3:::${self:provider.environment.S3_BUCKET_NAME}/*
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: "*"

functions:
  # Article Functions
  getArticles:
    handler: lambda/articles/getArticles.handler
    events:
      - http:
          path: /api/articles
          method: get
          cors: true

  getArticleBySlug:
    handler: lambda/articles/getArticleBySlug.handler
    events:
      - http:
          path: /api/articles/{slug}
          method: get
          cors: true

  searchArticles:
    handler: lambda/articles/searchArticles.handler
    events:
      - http:
          path: /api/articles/search
          method: get
          cors: true

  getTrendingArticles:
    handler: lambda/articles/getTrendingArticles.handler
    events:
      - http:
          path: /api/articles/trending
          method: get
          cors: true

  # Image Functions
  uploadImage:
    handler: lambda/images/uploadImage.handler
    events:
      - http:
          path: /api/images/upload
          method: post
          cors: true

  # Newsletter Functions
  subscribeNewsletter:
    handler: lambda/newsletter/subscribe.handler
    events:
      - http:
          path: /api/newsletter/subscribe
          method: post
          cors: true

  # Comment Functions
  addComment:
    handler: lambda/comments/addComment.handler
    events:
      - http:
          path: /api/comments
          method: post
          cors: true

  getComments:
    handler: lambda/comments/getComments.handler
    events:
      - http:
          path: /api/comments/{articleId}
          method: get
          cors: true

  # Analytics Functions
  trackView:
    handler: lambda/analytics/trackView.handler
    events:
      - http:
          path: /api/analytics/track
          method: post
          cors: true

resources:
  Resources:
    # DynamoDB Tables
    ArticlesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_TABLE_NEWS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: _id
            AttributeType: S
          - AttributeName: slug
            AttributeType: S
          - AttributeName: category
            AttributeType: S
          - AttributeName: createdAt
            AttributeType: S
        KeySchema:
          - AttributeName: _id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: slug-index
            KeySchema:
              - AttributeName: slug
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: category-createdAt-index
            KeySchema:
              - AttributeName: category
                KeyType: HASH
              - AttributeName: createdAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    SubscribersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_TABLE_SUBSCRIBERS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: email
            KeyType: HASH

    CommentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_TABLE_COMMENTS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: _id
            AttributeType: S
          - AttributeName: articleId
            AttributeType: S
          - AttributeName: createdAt
            AttributeType: S
        KeySchema:
          - AttributeName: _id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: articleId-index
            KeySchema:
              - AttributeName: articleId
                KeyType: HASH
              - AttributeName: createdAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    AnalyticsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_TABLE_ANALYTICS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: articleId
            AttributeType: S
          - AttributeName: timestamp
            AttributeType: S
        KeySchema:
          - AttributeName: articleId
            KeyType: HASH
          - AttributeName: timestamp
            KeyType: RANGE

    # S3 Bucket for Images
    ImagesBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.S3_BUCKET_NAME}
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - '*'
              AllowedMethods:
                - GET
                - PUT
                - POST
                - DELETE
              AllowedHeaders:
                - '*'
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false

    ImagesBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref ImagesBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal: '*'
              Action:
                - s3:GetObject
              Resource:
                - arn:aws:s3:::${self:provider.environment.S3_BUCKET_NAME}/*

    # CloudFront Distribution
    CloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Enabled: true
          Origins:
            - DomainName: ${self:provider.environment.S3_BUCKET_NAME}.s3.${self:provider.region}.amazonaws.com
              Id: S3Origin
              S3OriginConfig:
                OriginAccessIdentity: ''
          DefaultCacheBehavior:
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
            Compress: true
            MinTTL: 0
            DefaultTTL: 86400
            MaxTTL: 31536000
          PriceClass: PriceClass_100
          ViewerCertificate:
            CloudFrontDefaultCertificate: true

  Outputs:
    CloudFrontDomain:
      Value: !GetAtt CloudFrontDistribution.DomainName
      Export:
        Name: ${self:service}-${self:provider.stage}-CloudFrontDomain

plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 4000
